<!doctype html><html lang=en><head><title>ALEXFINN - Building and hacking minikube</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link href=../../css/milk.min.css rel=stylesheet><link href=../../css/milk-responsive.min.css rel=stylesheet><link href=../../css/style.css rel=stylesheet type=text/css media=all><link href=../../css/fonts.css rel=stylesheet type=text/css media=all><link rel="shortcut icon" href=../../images/alexfinn.ico><link rel=apple-touch-icon href><link rel=canonical href=../../post/minikube/><link href=../../rss.xml type=application/atom+xml rel=alternate></head><body><div class="navbar navbar-fixed-top"><div id=navbar-inner><div id=logo><a href><img src=../../images/letter-a.png width=100px></img></a></div></div></div><div class=container><div class=content><div class=row-fluid><div class=span12><div class=posts><div class=post><header class=post-header><h1><a href=../../post/minikube/>Building and hacking minikube</a></h1><div class=post-time>September 1 2019</div></header><div class=post-after><div class=tags></div></div><hr><div class="post content"><p>This document will outline the internals on minikube. It will outline how minikube works and what are the steps involved in running it inside an IDE. Having the ability to run inside the IDE will give the power of more better understanding by stepping through the code.</p><p>Minikube makes heavy use of VM and out of the box it supports VMs such as VirtualBox, Hyperkit, etc. We going to go through the VirtualBox setup in Linux environment for this article.</p><h2 id=prerequisite>Prerequisite</h2><p>Minikube has dependencies on packages that will need to be installed on your local dev machine. The best way to ensure that you have all the relevant packages installed is to run through the Quickstart <a href=https://kubernetes.io/docs/setup/learning-environment/minikube/>steps</a> on minikube tutorial website. Once you are able to run minikube on it&rsquo;s own on your dev machine you should be able to run and debug it without any problem from inside the IDE.</p><h2 id=building-minikube>Building minikube</h2><p>This article will be using GoLand IDE as it provide a lot of features that makes development in Go very easy. You can download the IDE <a href=https://www.jetbrains.com/go/>here</a> and install the IDE using the instruction outline on the website.</p><p>The GOPATH used in this article has been set to /home/nanik/Downloads/temp/packages</p><p><img src=../../media/gopath_structure.png alt=GoPathStructure></p><p>Completing the IDE installation checkout minikube into your GOPATH directory. On my local machine the minikube is stored under $GOPATH/src/k8s.io/minikube directory, as shows on the following screenshot</p><p><img src=../../media/minikube_ide.png alt=GoPathStructure></p><p>We need to setup the vendor directory for minikube by executing the following command</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>GO111MODULE</span>=<span style=color:#a6e22e>on</span> <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>mod</span> <span style=color:#a6e22e>vendor</span></code></pre></div><p>You will see vendor/ directory under the minikube source code.</p><p><img src=../../media/go_mod_vendor.png alt=GoPathStructure></p><p>Before running minikube there are code that need to be generated by executing the make command. On your terminal execute the following command</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>make</span></code></pre></div><p>The other step that need to be done is to set the correct version of the .iso file that will be used by minikube. This .iso file will be automatically downloaded when minikube starts up. The version need to be set inside the file version.go under pkg/version directory as shown below, set it to v1.3.0</p><p><img src=../../media/set_isoversion.png alt=isoversion></p><p>Once the make build is complete the minikube code is not ready. The main function to execute minikube is inside the file main.go under the cmd/minikube directory</p><p><img src=../../media/minikube_main_function.png alt=GoPathStructure></p><p>Following is the directory structure of minikube source code (the screenshot shows 2 level deep directory tree)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>├── cmd
│   ├── drivers
│   ├── extract
│   ├── gvisor
│   ├── minikube
│   └── storage-provisioner
├── deploy
│   ├── addons
│   ├── gvisor
│   ├── iso
│   ├── minikube
│   └── storage-provisioner
├── docs
│   └── contributors
├── hack
│   ├── boilerplate
│   ├── help_text
│   ├── jenkins
│   ├── kubernetes_version
│   ├── prow
│   └── release_notes
├── images
│   └── logo
├── installers
│   ├── darwin
│   ├── linux
│   └── windows
├── out
├── pkg
│   ├── drivers
│   ├── gvisor
│   ├── initflag
│   ├── kapi
│   ├── minikube
│   ├── provision
│   ├── storage
│   ├── util
│   └── version
├── site
│   ├── assets
│   ├── content
│   ├── layouts
│   ├── resources
│   ├── static
│   └── themes
├── test
│   └── integration
├── third_party
│   └── go9p
├── translations
└── vendor
    ├── cloud.google.com
    ├── github.com
    ├── golang.org
    ├── google.golang.org
    ├── go.opencensus.io
    ├── gopkg.in
    ├── k8s.io
    └── sigs.k8s.io</code></pre></div><p>Now we are ready to run the minikube. Use the parameter start as part of the program argument as shown in the screenshot</p><p><img src=../../media/minikube_start_configuration.png alt=minikubestartconfiguration></p><p>The parameter &ndash;v=7 used is to provide verbose logging to help in troubleshooting in case of issues. The log output will look somewhat like the following</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>😄  minikube v0.0.0-unset on ......
💡  Tip: Use &#39;minikube start -p &lt;<span style=color:#f92672>name</span>&gt;&#39; to create a new cluster, or &#39;minikube delete&#39; to delete this one.
COMMAND: /usr/bin/VBoxManage showvminfo minikube --machinereadable
STDOUT:
{
name=&#34;minikube&#34;
groups=&#34;/&#34;
ostype=&#34;Linux 2.6 / 3.x / 4.x (64-bit)&#34;
UUID=&#34;.....&#34;
CfgFile=&#34;/home/nanik/.minikube/machines/minikube/minikube/minikube.vbox&#34;
SnapFldr=&#34;/home/nanik/.minikube/machines/minikube/minikube/Snapshots&#34;
LogFldr=&#34;/home/nanik/.minikube/machines/minikube/minikube/Logs&#34;
hardwareuuid=&#34;.....&#34;
memory=2000


	.........
	.........
	.........
	.........
	

END SSH

🔄  Relaunching Kubernetes using kubeadm ... 
⌛  Waiting for: apiserver proxy etcd scheduler controller dns
🏄  Done! kubectl is now configured to use &#34;minikube&#34;
💡  For best results, install kubectl: https://kubernetes.io/docs/tasks/tools/install-kubectl/</code></pre></div><p>Once minikube has been ran successfully the application will exit as the VM now run in the bacground complete will the relevant kubernetes components installed inside it. To see the background process use the following command to peek into minikube running process on your machine</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>ps</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>A</span> | <span style=color:#a6e22e>grep</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>i</span> <span style=color:#a6e22e>vb</span></code></pre></div><p>you will see output similar to the following</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>.....
.....
28685 ?        00:00:51 VBoxXPCOMIPCD
28690 ?        00:02:35 VBoxSVC
28824 ?        15:53:35 VBoxHeadless
28841 ?        00:00:06 VBoxNetDHCP</code></pre></div><p>Now to confirm that all working well we need to execute command using minikube to check the cluster status. Use the following program argument to do this</p><p><img src=../../media/minikube_status.png alt=minikubestatus></p><p>You will get output that shows the following</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>host: Running
kubelet: Running
apiserver: Running
kubectl: Correctly Configured: pointing to minikube-vm at xx.xx.xx.xxs</code></pre></div><p>Now you are ready to start playing around with minikube source code.</p><hr><h2 id=how-minikube-works>How minikube works</h2><ul><li>when &lsquo;start&rsquo; parameter is trigger it will execute the vboxmanage to create VM</li><li>different vboxmanage commands are executed to the vm to configure it</li><li>different services are configured and run inside the VM</li><li>different things that can be done to the vm<ul><li>ssh into it</li><li>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
Inside minikube .iso
&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</li></ul></li></ul><p>The following command will build the minikube.iso</p><pre><code>make out/minikube.iso 2&gt;&amp;1 | tee buildminikubeiso.txt
</code></pre><ul><li>how to build the .iso</li><li>building .iso means creating rootfs + kernel using buildroot</li><li>show the content of the .iso files</li><li>extract and chroot the .iso files to show the content</li></ul><hr><h2 id=deploying-hello-world>Deploying hello-world</h2><ul><li><p><a href=https://kubernetes.io/docs/setup/learning-environment/minikube/>https://kubernetes.io/docs/setup/learning-environment/minikube/</a></p><ul><li><p>kubectl run hello-minikube &ndash;image=k8s.gcr.io/echoserver:1.10 &ndash;port=8080</p></li><li><p>kubectl expose deployment hello-minikube &ndash;type=NodePort</p></li><li><p>kubectl get pod</p></li><li><p>minikube service hello-minikube &ndash;url</p></li></ul></li></ul></div><div class=about><p></p></div><nav id=pagination></nav><footer>Built with <a href=https://github.com/spf13/hugo>Hugo</a><p>© Alexander Feller 2018</p></footer></div></div></div></div></div></body><script type=text/javascript>var _paq=_paq||[];_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){var u=(("https:"==document.location.protocol)?"https":"http")+":change-me";_paq.push(['setTrackerUrl',u+'piwik.php']);_paq.push(['setSiteId',4]);var d=document,g=d.createElement('script'),s=d.getElementsByTagName('script')[0];g.type='text/javascript';g.defer=true;g.async=true;g.src=u+'piwik.js';s.parentNode.insertBefore(g,s);})();</script><noscript><p><img src=http://change-me style=border:0 alt></p></noscript></html>